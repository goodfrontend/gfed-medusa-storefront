name: Stop Prod Instance Upgrade Window

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: prod-instance-upgrade-window-stop
  cancel-in-progress: true

jobs:
  stop:
    name: Force stop current upgrade window and scheduler chains
    runs-on: ubuntu-latest
    steps:
      - name: Force active window to end now
        id: force-end
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          ARTIFACT_NAME="prod-instance-upgrade-window"
          LIST_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts?name=${ARTIFACT_NAME}&per_page=100"

          list_status=$(curl -sS -o /tmp/stop_window_artifacts.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$LIST_URL")

          if [ "$list_status" != "200" ]; then
            echo "::error::Unable to list upgrade window artifacts (HTTP ${list_status})."
            cat /tmp/stop_window_artifacts.json
            exit 1
          fi

          artifact_json="$(jq -c '[.artifacts[] | select(.expired == false)] | sort_by(.created_at, .id) | last // empty' /tmp/stop_window_artifacts.json)"
          if [ -z "$artifact_json" ]; then
            echo "::notice::No active upgrade window artifact found. Continuing to cancel watcher chains only."
            echo "found_artifact=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          archive_url="$(echo "$artifact_json" | jq -r '.archive_download_url // empty')"
          if [ -z "$archive_url" ]; then
            echo "::error::Artifact metadata is incomplete (missing archive URL)."
            echo "$artifact_json"
            exit 1
          fi

          download_status=$(curl -sS -L -o /tmp/stop_window_artifact.zip -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$archive_url")

          if [ "$download_status" -ge 300 ]; then
            echo "::error::Unable to download active window artifact (HTTP ${download_status})."
            exit 1
          fi

          if ! unzip -p /tmp/stop_window_artifact.zip instance-window.json > instance-window.json 2>/dev/null; then
            echo "::error::Active window artifact does not contain instance-window.json."
            exit 1
          fi

          if ! jq -e . instance-window.json >/dev/null 2>&1; then
            echo "::error::Window payload is not valid JSON."
            cat instance-window.json
            exit 1
          fi

          now_epoch="$(date -u +%s)"
          now_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          NOW_EPOCH="$now_epoch" NOW_UTC="$now_utc" python - <<'PY'
          import json
          import os

          now_epoch = int(os.environ["NOW_EPOCH"])
          now_utc = os.environ["NOW_UTC"]

          with open("instance-window.json", "r", encoding="utf-8") as f:
              payload = json.load(f)

          payload["enabled"] = True
          payload["end_input"] = "immediate-stop"
          payload["end_utc"] = now_utc
          payload["end_epoch"] = now_epoch
          payload["stop_requested"] = True
          payload["stop_requested_by"] = os.getenv("GITHUB_ACTOR", "")
          payload["stop_requested_at_utc"] = now_utc
          payload["updated_by"] = os.getenv("GITHUB_ACTOR", "")
          payload["updated_at_utc"] = now_utc
          payload["source_workflow"] = os.getenv("GITHUB_WORKFLOW", "")
          payload["source_run_id"] = os.getenv("GITHUB_RUN_ID", "")

          start_epoch = payload.get("start_epoch")
          if not isinstance(start_epoch, int):
              payload["start_input"] = "immediate-stop"
              payload["start_utc"] = now_utc
              payload["start_epoch"] = now_epoch

          with open("instance-window.json", "w", encoding="ascii") as f:
              json.dump(payload, f, separators=(",", ":"))
          PY

          echo "found_artifact=true" >> "$GITHUB_OUTPUT"
          echo "forced_end_epoch=${now_epoch}" >> "$GITHUB_OUTPUT"
          echo "::notice::Forced active window end timestamp to ${now_utc} (${now_epoch})."

      - name: Upload forced-end window artifact
        if: steps.force-end.outputs.found_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: prod-instance-upgrade-window
          path: instance-window.json
          if-no-files-found: error
          retention-days: 30

      - name: Trigger immediate reconciliation
        env:
          GITHUB_TOKEN: ${{ github.token }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          workflow_file="prod-instance-upgrade-window-reconciler.yaml"
          dispatch_ref="${DEFAULT_BRANCH:-${GITHUB_REF_NAME}}"
          payload="$(jq -cn --arg ref "${dispatch_ref}" '{ref:$ref}')"

          dispatch_status=$(curl -sS -o /tmp/stop_reconciler_dispatch.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${workflow_file}/dispatches")

          if [ "$dispatch_status" != "204" ]; then
            echo "::error::Could not trigger immediate reconciliation (HTTP ${dispatch_status})."
            cat /tmp/stop_reconciler_dispatch.json
            exit 1
          fi

          echo "::notice::Triggered immediate reconciliation run."

      - name: Cancel start/end watcher chains
        env:
          GITHUB_TOKEN: ${{ github.token }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          dispatch_ref="${DEFAULT_BRANCH:-${GITHUB_REF_NAME}}"
          now_epoch="$(date -u +%s)"

          dispatch_workflow() {
            local workflow_file="$1"
            local payload="$2"
            local out_file="$3"

            curl -sS -o "$out_file" -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              -d "$payload" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${workflow_file}/dispatches"
          }

          start_payload="$(jq -cn \
            --arg ref "$dispatch_ref" \
            --arg start_epoch "$now_epoch" \
            --arg parent_run_id "${GITHUB_RUN_ID}" \
            '{ref:$ref,inputs:{start_epoch:$start_epoch,parent_run_id:$parent_run_id}}')"
          start_status="$(dispatch_workflow "prod-instance-upgrade-window-start-trigger.yaml" "$start_payload" /tmp/stop_start_watcher_dispatch.json)"
          if [ "$start_status" != "204" ]; then
            echo "::warning::Could not supersede start-time watcher chain (HTTP ${start_status})."
            cat /tmp/stop_start_watcher_dispatch.json
          else
            echo "::notice::Superseded start-time watcher chain."
          fi

          end_payload="$(jq -cn \
            --arg ref "$dispatch_ref" \
            --arg end_epoch "$now_epoch" \
            --arg parent_run_id "${GITHUB_RUN_ID}" \
            '{ref:$ref,inputs:{end_epoch:$end_epoch,parent_run_id:$parent_run_id}}')"
          end_status="$(dispatch_workflow "prod-instance-upgrade-window-end-trigger.yaml" "$end_payload" /tmp/stop_end_watcher_dispatch.json)"
          if [ "$end_status" != "204" ]; then
            echo "::warning::Could not supersede end-time watcher chain (HTTP ${end_status})."
            cat /tmp/stop_end_watcher_dispatch.json
          else
            echo "::notice::Superseded end-time watcher chain."
          fi
